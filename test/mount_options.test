#!/bin/bash

source taplib.sh

SOURCE_FILE="source.txt"
WORK_FILE="work.txt"
MOUNT_FILE="mount"

cleanup() {
    (fusermount -u "${MOUNT_FILE}" || true) 1>/dev/null 2>&1
    rm -rf "${SOURCE_FILE}"
    rm -rf "${WORK_FILE}"
    rm -rf "${MOUNT_FILE}"
}

trap cleanup INT TERM EXIT

make_files () {
    local size="$1"
    local written=0

    set -euo pipefail
    cleanup

    touch "${MOUNT_FILE}"
    touch "${SOURCE_FILE}"

    if [ "${size}" != 0 ]; then
        dd if=/dev/urandom of="${SOURCE_FILE}" bs=${size} count=1 status=none
    fi

    sync
    cp ${SOURCE_FILE} "${WORK_FILE}"
}

validate_size() {
    local filename="$1"
    local size="$2"

    test "$(stat -c %s $filename)" = "$size"
}

assert_ok "Testing basic mount/unmount" << END
    set -e
    make_files 256
    partfs "${SOURCE_FILE}" "${MOUNT_FILE}"
    fusermount -u "${MOUNT_FILE}"
END

assert_ok "Testing that mount fails on nonempty file" << END
    set -e
    make_files 256
    cp "${SOURCE_FILE}" "${MOUNT_FILE}"
    ! partfs "${SOURCE_FILE}" "${MOUNT_FILE}" 1>/dev/null 2>&1
END

assert_ok "Testing -o nonempty mount option" << END
    set -e
    make_files 256
    cp "${SOURCE_FILE}" "${MOUNT_FILE}"
    partfs "${SOURCE_FILE}" "${MOUNT_FILE}" -o nonempty
    fusermount -u "${MOUNT_FILE}"
END

assert_ok "Testing that mount fails on a directory" << END
    set -e
    make_files 256
    rm -f "${MOUNT_FILE}"
    mkdir "${MOUNT_FILE}"
    ! partfs "${SOURCE_FILE}" "${MOUNT_FILE}" 1>/dev/null 2>&1
    rmdir "${MOUNT_FILE}"
END

assert_ok "Testing the size of a mounted file" << END
    set -e
    make_files 256

    partfs "${SOURCE_FILE}" "${MOUNT_FILE}" -o offset=5
    validate_size "${MOUNT_FILE}" 251
    fusermount -u "${MOUNT_FILE}"

    partfs "${SOURCE_FILE}" "${MOUNT_FILE}" -o offset=5,size=37
    validate_size "${MOUNT_FILE}" 37
    fusermount -u "${MOUNT_FILE}"

    partfs "${SOURCE_FILE}" "${MOUNT_FILE}" -o offset=256
    validate_size "${MOUNT_FILE}" 0
    fusermount -u "${MOUNT_FILE}"

    cleanup
END

assert_ok "Testing the that an oversized mount fails" << END
    set -e

    make_files 256
    partfs "${SOURCE_FILE}" "${MOUNT_FILE}"
    fusermount -u "${MOUNT_FILE}"

    partfs "${SOURCE_FILE}" "${MOUNT_FILE}" -o offset=256
    fusermount -u "${MOUNT_FILE}"

    partfs "${SOURCE_FILE}" "${MOUNT_FILE}" -o offset=255,size=1
    fusermount -u "${MOUNT_FILE}"

    ! partfs "${SOURCE_FILE}" "${MOUNT_FILE}" -o offset=256,size=1 2>/dev/null
    ! partfs "${SOURCE_FILE}" "${MOUNT_FILE}" -o offset=255,size=2 2>/dev/null
END

assert_ok "Testing a size-0 mount" << END
    set -e

    make_files 0
    partfs "${SOURCE_FILE}" "${MOUNT_FILE}"
    fusermount -u "${MOUNT_FILE}"
    cleanup
END

assert_ok "Testing read-only mounts" << END
    set -euo pipefail

    make_files 256
    partfs "${SOURCE_FILE}" "${MOUNT_FILE}"
    cat "${MOUNT_FILE}" 1>/dev/null
    echo "test string" | (tee "${MOUNT_FILE}" 1>/dev/null)
    fusermount -u "${MOUNT_FILE}"
    cleanup

    make_files 256
    partfs "${SOURCE_FILE}" "${MOUNT_FILE}" -o ro
    cat "${MOUNT_FILE}" 1>/dev/null
    echo "test string" | (! tee "${MOUNT_FILE}" 1>/dev/null 2>&1)
    fusermount -u "${MOUNT_FILE}"
    cleanup
END
